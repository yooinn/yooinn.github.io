<!DOCTYPE html>
<html>
  <head>
      
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Jiank</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="温故而知新"/>
<meta name="keywords" content="温故而知新"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://yooinn.github.io//favicon.ico">

<link rel="stylesheet" href="https://yooinn.github.io//styles/main.css">

<!-- Modernizr JS -->
<script src="https://yooinn.github.io/media/scripts/vendors/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://yooinn.github.io//media/scripts/_vendors/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->

    
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
    

    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/tomorrow-night.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<link crossorigin="anonymous" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" href="https://lib.baomitu.com/font-awesome/5.8.1/css/all.min.css" rel="stylesheet">

  </head>
  <body>
  
<div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://yooinn.github.io//media/images/avatar.png" alt="Jiank" class="img-responsive">
        </figure>
        <h3 class="heading">ABOUT ME</h3>
        <h2>Jiank</h2>
        <p>温故而知新</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">
        <div class="fh5co-box">
            <h3 class="heading">搜索</h3>
            <form action="#">
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="输入关键字">
                </div>
            </form>
        </div>
        <div class="fh5co-box">
            <h3 class="heading">标签</h3>
            <ul>
                
                    <li><a href="https://yooinn.github.io//tag/FuqRNjlSWx">爬虫</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/tXH4POF09">python</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/LIFaQWPrF">Centos</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/QRAqbdG_m">django</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/ewoty_xe6">CSRF</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/Mz5dw6SaJF">攻击</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/mgBwHqvScq">代理</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/wV8K1iN-L">sublime</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/FTcnjIO1M9">开发环境</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/slsqa3JFOO">加密</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/IL7UdZM90j">解密</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/HOyveGXQl">redis</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/b9SNjXwUQ6">缓存</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/zE5M8ZF1G">算法</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/8ds-G3FOk2">队列 消息 线程</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/QakZrWwK7">mysql</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/gridea">Gridea</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                         >
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                         >
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                         >
                            标签
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                         >
                            关于
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://yooinn.github.io/">Jiank</a>
                </h1>
            </div>
        </div>
    </div>
</header>


<!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
<!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

  <div class="container-fluid">
      <div class="row fh5co-post-entry single-entry">
          <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
              <figure class="animate-box">
                  
              </figure>
              <span class="fh5co-meta animate-box">
                  
                      <div class="tag-container">
                          
                              <a href="https://yooinn.github.io//tag/tXH4POF09" class="tag">python, </a>
                          
                      </div>
                  
              </span>
              <h2 class="fh5co-article-title animate-box">Python写一个基于MD5的文件监听程序</h2>
              <span class="fh5co-meta fh5co-date animate-box">2019-09-20</span>

              <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                  <div class="row">
                      <div class="col-md-12 animate-box post-content">
                          <p> <p>前述</p>
<p>写了一个基于MD5算法的文件监听程序，通过不同的文件能够生成不同的哈希函数，来实现实现判断文件夹中的文件的增加、修改、删除和过滤含有特定字符的文件名的文件。</p>
<p>需求说明<br>
需要实现对一个文件夹下的文件的增加、修改和删除的监控， 一旦发生上述操作，则进行提示。可以选择过滤掉文件名中的特定字符和只监听文件名中含有特定字符的文件。</p>
<p>简述<br>
首先，关于文件的增加、修改、删除的反馈，可以想到利用MD5等类似的加密算法，因为文件本身可以生成哈希值，只要文件内容或者文件名被修改过，就会生成和修改之前的哈希值不同的值，因此可以利用dict来存储，一个文件名对应一个哈希值来存储。其中增加和删除就对应一个新增加的键值对和一个减少的键值对，而修改则可以理解为删除了旧的文件、增加了一个新的文件。<br>
MD5算法可以直接利用第三方的 hashlib 库来实现</p>
<p>m = hashlib.md5()<br>
myFile = open(full_path, 'rb')<br>
for line in myFile.readlines(): #以行为单位不断更新哈希值，避免文件过大导致一次产生大量开销<br>
m.update(line) #最后可以得到整个文件的哈希值<br>
第二，关于滤掉文件名中的特定字符和只监听文件名中含有特定字符的文件的功能，这个其实非常简单，只需要用 list 分别对需要过滤和必须存在字符串进行存储， 然后利用标志位和字符串的子串包含性进行判断就可以了，只有满足条件的文件可以产生哈希值，产生哈希值也就意味着被监听了。<br>
判断字符串中是否含有字串最常用的方法是 in 和 string 中的 find 方法，这里就不再赘述，可以直接看下面的代码</p>
<p>第三，因为要同时监控多个文件夹，所以必须要利用到线程来处理，创建一个线程池来存储线程， 线程利用了 threading 库，并且实现一个线程类来处理线程的操作<br>
class myListener(threading.Thread):<br>
thread1 = myListener(mydir, json_list_include, json_list_exclude) #生成线程<br>
说明<br>
需要额外说明的一点是，在传输需要监听的文件夹、必须包含的字段以及过滤字段的时候，我这里是利用配置文件的形式来存储的。说到底，是利用 toml 格式的数据进行的传输，toml格式和 json格式相比，用户的可读性更强一些，为了便于博客展示，因此利用了 toml 格式</p>
<p>首先利用代码生成了一下toml格式的文件，以后再想用的话，程序打包之后，可以直接修改配置文件来实现对程序的控制。</p>
<p>#!/usr/bin/env python</p>
<h1 id="-codingutf-8-">-<em>- coding:utf-8 -</em>-</h1>
<h1 id="author-jyroooy">Author: JYRoooy</h1>
<p>import collections<br>
import json<br>
import toml<br>
if <strong>name</strong> == '<strong>main</strong>':<br>
myOrderDict = collections.OrderedDict<br>
myOrderDict = {'dict':[{'path':'E:/testing', 'include':['log_'], 'exclude': ['.swp', '.swx', 'tmp']},{'path':'E:/tmp', 'include':['.record'], 'exclude': ['.tmp']}]}<br>
myToml = toml.dump(myOrderDict, open('E:/python/code/PythonProject/tomlConfig.txt','w+'))<br>
toml文件</p>
<p>格式说明， 一个 dict 对应一个监听的文件夹和需要 过滤(exculde) 和 含有(include) 的字段，解释一下，这里的字段只是文件名的字段，监控 E:/testing 目录下的文件，要包含 log_ 字段的文件，且不包含 .swp .swx .tmp 字段的文件， 并且监控 E:/tmp 目录下的文件，要包含 .record 字段的文件，且不包含 .tmp 的文件。<br>
<img src="https://files.jb51.net/file_images/article/201903/2019311100740411.png?201921110747" alt=""><br>
代码<br>
完整程序的代码，具体解释可以看注释</p>
<pre><code>#!/usr/bin/env python
# -*- coding:utf-8 -*-
# Author: JYRoooy
import toml
import hashlib
import os
import sys
import time
import importlib
import threading
importlib.reload(sys)

class myListener(threading.Thread):
 '''
 监听类
 '''
 def __init__(self, input_dir, filt_in, filt_ex): #文件夹路径，必须包含的字符，必须过滤的字符
 threading.Thread.__init__(self)
 self.input_dir = input_dir
 self.filt_in = filt_in
 self.filt_ex = filt_ex
 self.dict = {} #用来存储文件名和对应的哈希值
 self.file_list = [] #存储每一次扫描时的文件的文件名
 self.pop_list = [] #存储需要删除的文件名

 def run(self):
 while (1): #保证文件夹一直处于被监听的状态
  for cur_dir, dirs, files in os.walk(self.input_dir):
  if files != []:
   self.file_list = []
   for each_file_1 in files:
   each_file = each_file_1
   if self.filt_in: #判断文件名中是否有必须存在的字段
    flagone = 0
    for i in range(len(self.filt_in)):
    if self.filt_in[i] in each_file:
     flagone += 1
    if flagone == 0:
    continue

   if self.filt_ex: #判断文件名中是否有必须过滤掉的字段
    flagtwo = 0
    for i in range(len(self.filt_ex)):
    if self.filt_ex[i] in each_file:
     flagtwo = 1
    if flagtwo==1:
    continue

   self.file_list.append(each_file)
   full_path = os.path.join(cur_dir, each_file)
   m = hashlib.md5() #实例化md5算法

   myFile = open(full_path, 'rb')

   for line in myFile.readlines():
    m.update(line)
   if each_file not in self.dict.keys(): #如果当前的dict中没有这个文件，那么就添加进去
    self.dict[each_file] = m.hexdigest() #生成哈希值
    print('文件夹:' +cur_dir+ &quot;中的文件名为：&quot; + each_file + &quot;的文件为新文件&quot; + time.strftime('%Y-%m-%d %H:%M:%S',
           time.localtime(time.time())))
   if each_file in self.dict.keys() and self.dict[each_file] != m.hexdigest(): #如果当前dict中有这个文件，但是哈希值不同，说明文件被修改过，则需要对字典进行更新
    print('文件夹:' +cur_dir+ &quot;中的文件名为：&quot; + each_file + &quot;的文件被修改于&quot; + time.strftime('%Y-%m-%d %H:%M:%S',
           time.localtime(time.time())))
    self.dict[each_file] = m.hexdigest()
   myFile.close()
  pop_list = []
  for i in self.dict.keys():
   if i not in self.file_list: #当字典中有不在当前文件名列表中时，说明文件已经被删除
   print('文件夹:' +cur_dir+ '中的文件名为:' + i + &quot;的文件已被删除!!!&quot; + time.strftime('%Y-%m-%d %H:%M:%S',
          time.localtime(time.time())))
   pop_list.append(i)
  for i in pop_list:
   self.dict.pop(i)

  time.sleep(2)

if __name__ == '__main__':
 threads = [] #用来存储线程的线程池
 with open('E:/python/code/PythonProject/tomlConfig.txt','r+') as f: #读取toml格式的文件，并分解格式
 mytoml = toml.load(f)
 myList = mytoml['dict']
 for i in range(len(myList)): #因为可能同时需要监听多个文件夹，所以利用线程池处理多线程
  json_list_include = []
  json_list_exclude = []
  mydir = myList[i]['path']
  for sublist in range(len(myList[i]['include'])):
  json_list_include.append(myList[i]['include'][sublist])
  for sublist in range(len(myList[i]['exclude'])):
  json_list_exclude.append(myList[i]['exclude'][sublist])
  thread1 = myListener(mydir, json_list_include, json_list_exclude) #生成线程
  threads.append(thread1)

 for t in threads: #开启所有线程
  t.start();
</code></pre>
<p>运行结果<br>
两个文件夹中的文件<br>
<img src="https://files.jb51.net/file_images/article/201903/2019311100842641.png?201921110849" alt=""><br>
第一次运行程序， 可以看到已经按照过滤规则完成了过滤和监听<br>
<img src="https://files.jb51.net/file_images/article/201903/2019311100945510.png?201921110951" alt=""><br>
修改 loko.record 文件为 loko.re，再来看结果<br>
<img src="https://files.jb51.net/file_images/article/201903/2019311101001277.png?201921110107" alt=""></p>
<p>可以看到已经完成了监听，因为 loko.re 文件，并符合监听的规则，所以不做出监听，而我们前面说过，一个修改相当于一个删除和一个新建操作，所以监听程序提示原文件被删除了</p>
 </p>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-12 animate-box">
                          
                              <div class="next-post">
                                  <div class="next">下一篇</div>
                                  <a href="https://yooinn.github.io//post/django-simple-captcha-tu-xing-yan-zheng-ma-mo-kuai">
                                      <h3 class="post-title">
                                          django-simple-captcha 图形验证码模块
                                      </h3>
                                  </a>
                              </div>
                          
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-12 animate-box">
                          
                              
                                  <div id="gitalk-container"></div>
                              

                              
                          
                      </div>
                  </div>
              </div>

          </article>
      </div>
  </div>

    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://yooinn.github.io/" target="_blank">Jiank</a></p>
</footer>


    
<!-- jQuery -->
<script src="https://yooinn.github.io//media/scripts/vendors/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="https://yooinn.github.io//media/scripts/vendors/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://yooinn.github.io//media/scripts/vendors/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://yooinn.github.io//media/scripts/vendors/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://yooinn.github.io//media/scripts/vendors/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://yooinn.github.io//media/scripts/vendors/md5.min.js"></script>

<script type="application/javascript">
    hljs.initHighlightingOnLoad();
</script>



    
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>

            var gitalk = new Gitalk({
                clientID: '18da3e757583aa6301c0',
                clientSecret: '49cea6508bf61d7606bce51766288ea312bd7456',
                repo: 'yooinn.github.io',
                owner: 'yooinn',
                admin: ['yooinn'],
                id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                distractionFreeMode: false  // Facebook-like distraction free mode
            })

            gitalk.render('gitalk-container')

        </script>
    

    




  </body>
</html>
