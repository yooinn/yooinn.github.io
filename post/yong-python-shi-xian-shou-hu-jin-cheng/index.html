<!DOCTYPE html>
<html>
  <head>
      
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Jiank</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="温故而知新"/>
<meta name="keywords" content="温故而知新"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://yooinn.github.io//favicon.ico">

<link rel="stylesheet" href="https://yooinn.github.io//styles/main.css">

<!-- Modernizr JS -->
<script src="https://yooinn.github.io/media/scripts/vendors/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://yooinn.github.io//media/scripts/_vendors/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->

    
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
    

    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/tomorrow-night.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<link crossorigin="anonymous" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" href="https://lib.baomitu.com/font-awesome/5.8.1/css/all.min.css" rel="stylesheet">

  </head>
  <body>
  
<div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://yooinn.github.io//media/images/avatar.png" alt="Jiank" class="img-responsive">
        </figure>
        <h3 class="heading">ABOUT ME</h3>
        <h2>Jiank</h2>
        <p>温故而知新</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">
        <div class="fh5co-box">
            <h3 class="heading">搜索</h3>
            <form action="#">
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="输入关键字">
                </div>
            </form>
        </div>
        <div class="fh5co-box">
            <h3 class="heading">标签</h3>
            <ul>
                
                    <li><a href="https://yooinn.github.io//tag/tXH4POF09">python</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/QRAqbdG_m">django</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/jj-MVXJyc">mongodb</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/FuqRNjlSWx">爬虫</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/LIFaQWPrF">Centos</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/ewoty_xe6">CSRF</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/Mz5dw6SaJF">攻击</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/mgBwHqvScq">代理</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/wV8K1iN-L">sublime</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/FTcnjIO1M9">开发环境</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/slsqa3JFOO">加密</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/IL7UdZM90j">解密</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/HOyveGXQl">redis</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/b9SNjXwUQ6">缓存</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/zE5M8ZF1G">算法</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/8ds-G3FOk2">队列 消息 线程</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/QakZrWwK7">mysql</a></li>
                
                    <li><a href="https://yooinn.github.io//tag/gridea">Gridea</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                         >
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                         >
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                         >
                            标签
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                         >
                            关于
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://yooinn.github.io/">Jiank</a>
                </h1>
            </div>
        </div>
    </div>
</header>


<!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
<!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

  <div class="container-fluid">
      <div class="row fh5co-post-entry single-entry">
          <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
              <figure class="animate-box">
                  
              </figure>
              <span class="fh5co-meta animate-box">
                  
                      <div class="tag-container">
                          
                              <a href="https://yooinn.github.io//tag/tXH4POF09" class="tag">python, </a>
                          
                      </div>
                  
              </span>
              <h2 class="fh5co-article-title animate-box">用Python实现守护进程</h2>
              <span class="fh5co-meta fh5co-date animate-box">2019-09-19</span>

              <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                  <div class="row">
                      <div class="col-md-12 animate-box post-content">
                          <p> <p>Daemon场景<br>
考虑如下场景：你编写了一个python服务程序，并且在命令行下启动，而你的命令行会话又被终端所控制，python服务成了终端程序的一个子进程。因此如果你关闭了终端，这个命令行程序也会随之关闭。</p>
<p>要使你的python服务不受终端影响而常驻系统，就需要将它变成守护进程。</p>
<p>守护进程就是Daemon程序，是一种在系统后台执行的程序，它独立于控制终端并且执行一些周期任务或触发事件，通常被命名为&quot;d&quot;字母结尾，如常见的httpd、syslogd、systemd和dockerd等。</p>
<p>代码实现<br>
python可以很简洁地实现守护进程，下面给出代码和相应注释。这份代码稳定运行在我本地电脑的一个守护进程(自制闹钟)里，暂时没出过问题。</p>
<pre><code># coding=utf8
import os
import sys
import atexit
def daemonize(pid_file=None):
    &quot;&quot;&quot;
    创建守护进程
    :param pid_file: 保存进程id的文件
    :return:
    &quot;&quot;&quot;
    # 从父进程fork一个子进程出来
    pid = os.fork()
    # 子进程的pid一定为0，父进程大于0
    if pid:
        # 退出父进程，sys.exit()方法比os._exit()方法会多执行一些刷新缓冲工作
        sys.exit(0)
    # 子进程默认继承父进程的工作目录，最好是变更到根目录，否则回影响文件系统的卸载
    os.chdir('/')
    # 子进程默认继承父进程的umask（文件权限掩码），重设为0（完全控制），以免影响程序读写文件
    os.umask(0)
    # 让子进程成为新的会话组长和进程组长
    os.setsid()
    # 注意了，这里是第2次fork，也就是子进程的子进程，我们把它叫为孙子进程
    _pid = os.fork()
    if _pid:
        # 退出子进程
        sys.exit(0)
    # 此时，孙子进程已经是守护进程了，接下来重定向标准输入、输出、错误的描述符(是重定向而不是关闭, 这样可以避免程序在 print 的时候出错)
    # 刷新缓冲区先，小心使得万年船
    sys.stdout.flush()
    sys.stderr.flush()
    # dup2函数原子化地关闭和复制文件描述符，重定向到/dev/nul，即丢弃所有输入输出
    with open('/dev/null') as read_null, open('/dev/null', 'w') as write_null:
        os.dup2(read_null.fileno(), sys.stdin.fileno())
        os.dup2(write_null.fileno(), sys.stdout.fileno())
        os.dup2(write_null.fileno(), sys.stderr.fileno())
    # 写入pid文件
    if pid_file:
        with open(pid_file, 'w+') as f:
            f.write(str(os.getpid()))
        # 注册退出函数，进程异常退出时移除pid文件
        atexit.register(os.remove, pid_file)
</code></pre>
<p><strong>概括一下守护进程的编写步骤：</strong></p>
<p>1、fork出子进程，退出父进程</p>
<p>2、子进程变更工作目录(chdir)、文件权限掩码(umask)、进程组和会话组(setsid)</p>
<p>3、子进程fork孙子进程，退出子进程</p>
<p>4、孙子进程刷新缓冲，重定向标准输入／输出／错误（一般到/dev/null，意即丢弃）</p>
<p>5、(可选)pid写入文件</p>
<p>理解几个要点<br>
为什么要fork两次<br>
第一次fork，是为了脱离终端控制的魔爪。父进程之所以退出，是因为终端敲击键盘、或者关闭时给它发送了信号；而fork出来的子进程，在父进程自杀后成为孤儿进程，进而被操作系统的init进程接管，因此脱离终端控制。</p>
<p>所以其实，第二次fork并不是必须的（很多开源项目里的代码就没有fork两次）。只不过出于谨慎考虑，防止进程再次打开一个控制终端。因为子进程现在是会话组长了（对话期的首次进程），有能力打开控制终端，再fork一次，孙子进程就不能打开控制终端了。</p>
<p>文件描述符<br>
Linux是“一切皆文件”，文件描述符是内核为已打开的文件所创建的索引，通常是非负整数。进程通过文件描述符执行IO操作。</p>
<p>每个进程有自己的文件描述符表，因此相同的描述符可能指向同一个文件，也可能指向不同文件；来自不同进程的不同的描述符，当然也有可能指向同一个文件。</p>
<p>默认情况下，0代表标准输入，1代表标准输出，2代表标准错误。</p>
<p>umask权限掩码<br>
我们知道，在Linux中，任何一个文件都有读（read）、写（write）和执行（execute）的三种使用权限。其中，读的权限用数字4代表，写权限是2，执行权限是1。命令ls -l可以查看文件权限，r/w/x分别表示具有读/写/执行权限。</p>
<p>任何文件，也都有用户（User）,用户组（Group）,其他组（Others）三种身份权限。一般用3个数字表示文件权限，例如754：</p>
<p>7，是User权限，即文件拥有者权限</p>
<p>5，是Group权限，拥有者所在用户组的组员所具有的权限</p>
<p>4，是Others权限，即其他组用户的权限啦</p>
<p>而umask是为了控制默认权限，防止新建文件或文件夹具有全权。</p>
<p>系统一般默认为022（使用命令umask查看），表示默认创建文件的权限是644，文件夹是755。你应该可以看出它们的规律，就是文件权限和umask的相加结果为666（笑），文件夹权限和umask的相加结果为777。</p>
<p>进程组<br>
每个进程都属于一个进程组（PG,Process Group），进程组可以包含多个进程。</p>
<p>进程组有一个进程组长（Leader），进程组长的ID（PID, Process ID）就作为整个进程组的ID（PGID,Process Groupd ID）。</p>
<p>会话组<br>
登陆终端时，就会创造一个会话，多个进程组可以包含在一个会话中。而创建会话的进程，就是会话组长。</p>
<p>已经是会话组长的进程，不可以再调用setsid()方法创建会话。因此，上面代码中，子进程可以调用setsid()，而父进程不能，因为它本身就是会话组长。</p>
<p>另外，sh（Bourne Shell）不支持会话机制，因为会话机制需要shell支持工作控制（Job Control）。</p>
<p>守护进程与后台进程<br>
通过&amp;符号，可以把命令放到后台执行。它与守护进程是不同的：</p>
<p>1、守护进程与终端无关，是被init进程收养的孤儿进程；而后台进程的父进程是终端，仍然可以在终端打印</p>
<p>2、守护进程在关闭终端时依然坚挺；而后台进程会随用户退出而停止，除非加上nohup</p>
<p>3、守护进程改变了会话、进程组、工作目录和文件描述符，后台进程直接继承父进程（shell）的</p>
<p>换句话说：守护进程就是默默地奋斗打拼的有为青年，而后台进程是默默继承老爸资产的富二代。</p>
 </p>
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-12 animate-box">
                          
                              <div class="next-post">
                                  <div class="next">下一篇</div>
                                  <a href="https://yooinn.github.io//post/python-">
                                      <h3 class="post-title">
                                          Python中线程的MQ消息队列实现以及消息队列的优点解析
                                      </h3>
                                  </a>
                              </div>
                          
                      </div>
                  </div>

                  <div class="row">
                      <div class="col-md-12 animate-box">
                          
                              
                                  <div id="gitalk-container"></div>
                              

                              
                          
                      </div>
                  </div>
              </div>

          </article>
      </div>
  </div>

    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://yooinn.github.io/" target="_blank">Jiank</a></p>
</footer>


    
<!-- jQuery -->
<script src="https://yooinn.github.io//media/scripts/vendors/jquery.min.js"></script>
<!-- jQuery Easing -->
<script src="https://yooinn.github.io//media/scripts/vendors/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://yooinn.github.io//media/scripts/vendors/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://yooinn.github.io//media/scripts/vendors/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://yooinn.github.io//media/scripts/vendors/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://yooinn.github.io//media/scripts/vendors/md5.min.js"></script>

<script type="application/javascript">
    hljs.initHighlightingOnLoad();
</script>



    
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>

            var gitalk = new Gitalk({
                clientID: '18da3e757583aa6301c0',
                clientSecret: '49cea6508bf61d7606bce51766288ea312bd7456',
                repo: 'yooinn.github.io',
                owner: 'yooinn',
                admin: ['yooinn'],
                id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                distractionFreeMode: false  // Facebook-like distraction free mode
            })

            gitalk.render('gitalk-container')

        </script>
    

    




  </body>
</html>
